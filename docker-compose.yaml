configs:
  realm-template:
    file: ./docker/keycloak/dfsps-realm.json

volumes:
  keycloak-import: {}
  vault-data: {}
  vault-creds: {}
  mailpit-data: {}

services:

  traefik:
    image: traefik
    command:
      - --entrypoints.web.address=:80
      - --providers.docker=true
      - --api.dashboard=true
      - --api.insecure=true
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_DASHBOARD_PORT:-8090}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      default:
        aliases:
          - ${COMPOSE_DOMAIN:-mcm.localhost}
          - vault.${COMPOSE_DOMAIN:-mcm.localhost}
          - keycloak.${COMPOSE_DOMAIN:-mcm.localhost}
          - mailpit.${COMPOSE_DOMAIN:-mcm.localhost}
    restart: always

  connection-manager-ui:
    image: ghcr.io/pm4ml/connection-manager-ui
    hostname: connection-manager-ui
    profiles:
      - dev
    environment:
      - AUTH_ENABLED=TRUE
      - API_BASE_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}
      - LOGIN_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/login
      - LOGOUT_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/logout
      - CHECK_SESSION_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/profile
    labels:
      - "traefik.http.routers.mcm-ui.rule=Host(`${COMPOSE_DOMAIN:-mcm.localhost}`) && !PathPrefix(`/api`)"
      - "traefik.http.services.mcm-ui.loadbalancer.server.port=8080"
    tty: true
    stdin_open: true
    restart: always
    depends_on:
      connection-manager-api:
        condition: service_healthy

  connection-manager-migration:
    image: mojaloop/connection-manager-api:local
    pull_policy: if_not_present
    build:
      context: .
      dockerfile: Dockerfile
    profiles:
      - functional
    env_file: ./test/.env-func
    environment:
      - DATABASE_HOST=connection-manager-db
      - DATABASE_USER=${DBUSER:-mcm}
      - DATABASE_PASSWORD=${DBPASS:-mcm}
      - DATABASE_SCHEMA=${DBUSER:-mcm}
      - VAULT_ENDPOINT=http://vault-dev:8233
      - VAULT_ROLE_ID_FILE=/vault/tmp/role-id
      - VAULT_ROLE_SECRET_ID_FILE=/vault/tmp/secret-id
    volumes:
      - ./docker/vault/tmp:/vault/tmp
    depends_on:
      connection-manager-db:
        condition: service_healthy
      vault-dev:
        condition: service_healthy
    command: npm run migrate
    restart: "no"

  connection-manager-api:
    image: mojaloop/connection-manager-api:local
    pull_policy: if_not_present
    build:
      context: .
      dockerfile: Dockerfile
    profiles:
      - functional
    env_file: ./test/.env-func
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-moja123}
      - DATABASE_HOST=connection-manager-db
      - DATABASE_USER=${DBUSER:-mcm}
      - DATABASE_PASSWORD=${DBPASS:-mcm}
      - DATABASE_SCHEMA=${DBUSER:-mcm}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-moja123}
      - PORT=3001
      - SWITCH_ID=switch
      - VAULT_ENDPOINT=http://vault:8233
      - VAULT_AUTH_METHOD=APP_ROLE
      - VAULT_ROLE_ID_FILE=/vault/role-id
      - VAULT_ROLE_SECRET_ID_FILE=/vault/secret-id
      - VAULT_PKI_CLIENT_ROLE=example.com
      - VAULT_PKI_SERVER_ROLE=example.com
      - OPENID_ENABLED=true
      - OPENID_ENABLE_2FA=false
      - OPENID_ALLOW_INSECURE=true
      - OPENID_DISCOVERY_URL=http://keycloak.${COMPOSE_DOMAIN:-mcm.localhost}/realms/dfsps
      - OPENID_CLIENT_ID=connection-manager-auth-client
      - OPENID_CLIENT_SECRET=dfsps456
      - OPENID_AUDIENCE=connection-manager-api
      - LOGIN_CALLBACK=http://${COMPOSE_DOMAIN:-mcm.localhost}/api/auth/callback
      - KEYCLOAK_ENABLED=true
      - KEYCLOAK_AUTO_CREATE_ACCOUNTS=true
      - KEYCLOAK_BASE_URL=http://keycloak.${COMPOSE_DOMAIN:-mcm.localhost}
      - KEYCLOAK_DISCOVERY_URL=http://keycloak.${COMPOSE_DOMAIN:-mcm.localhost}/realms/dfsps/.well-known/openid-configuration
      - KEYCLOAK_ADMIN_CLIENT_ID=connection-manager-api-service
      - KEYCLOAK_ADMIN_CLIENT_SECRET=dfsps123
      - CLIENT_URL=http://${COMPOSE_DOMAIN:-mcm.localhost}
      - SESSION_COOKIE_SAME_SITE_STRICT=false
      - CLIENT_CSR_PARAMETERS=/resources/tlsClientCSRParameters.json
      - SERVER_CSR_PARAMETERS=/resources/tlsServerCSRParameters.json
      - CA_CSR_PARAMETERS=/resources/caCSRParameters.json
      - VAULT_SIGN_EXPIRY_HOURS=4000
      - INTERNAL_CA_TTL=8760h
    labels:
      - "traefik.http.routers.mcm-api.rule=Host(`${COMPOSE_DOMAIN:-mcm.localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.services.mcm-api.loadbalancer.server.port=3001"
    volumes:
      - vault-creds:/vault
      - ./docker/mcm/resources:/resources:ro
    tty: true
    stdin_open: true
    restart: always
    depends_on:
      vault-init:
        condition: service_completed_successfully
      keycloak:
        condition: service_healthy
      connection-manager-migration:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:3001/api/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  connection-manager-db:
    image: mysql:9
    ports:
      - "${DATABASE_PORT:-3306}:3306"
    volumes:
      - ./docker/sql-init/:/docker-entrypoint-initdb.d/
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-modus123}
      - MYSQL_USER=${DBUSER:-mcm}
      - MYSQL_PASSWORD=${DBPASS:-mcm}
      - MYSQL_DATABASE=${DBUSER:-mcm}
    healthcheck:
      test: ["CMD-SHELL", "mysql -h localhost -u$$MYSQL_USER -p$$MYSQL_PASSWORD -e 'SELECT 1'"]
      interval: 5s
      timeout: 3s
      retries: 20

  vault:
    image: hashicorp/vault:1.20
    command: server
    restart: always
    tty: true
    stdin_open: true
    environment:
      VAULT_ADDR: http://127.0.0.1:8233
      VAULT_API_ADDR: http://0.0.0.0:8233
      VAULT_LOCAL_CONFIG: '{"listener": [{"tcp": {"address": "0.0.0.0:8233", "tls_disable": true}}], "storage": {"file": {"path": "/vault/data"}}, "default_lease_ttl": "8760h", "max_lease_ttl": "87600h", "ui": true}'
    labels:
      - "traefik.http.routers.vault.rule=Host(`vault.${COMPOSE_DOMAIN:-mcm.localhost}`)"
      - "traefik.http.services.vault.loadbalancer.server.port=8233"
    volumes:
      - vault-data:/vault/data
      - vault-creds:/vault/creds
      - ./docker/vault/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://127.0.0.1:8233/v1/sys/health?sealedcode=200&uninitcode=200"]
      interval: 3s
      timeout: 2s
      retries: 10
      start_period: 3s

  vault-init:
    build:
      context: ./docker/vault
      dockerfile_inline: |
        FROM alpine:latest
        RUN apk add --no-cache curl jq
    environment:
      VAULT_ADDR: http://vault:8233
    volumes:
      - vault-data:/vault/data
      - vault-creds:/vault/creds
      - ./docker/vault/vault-init.sh:/vault-init.sh
    depends_on:
      vault:
        condition: service_healthy
    entrypoint: /vault-init.sh
    restart: "no"

  volume_explorer:
    image: alpine
    command: sh -c 'cp -r /vault/creds/. /creds/ && tail -f /dev/null'
    volumes:
      - vault-creds:/vault/creds:ro
      - ./docker/vault/tmp:/creds:rw
    depends_on:
      vault-init:
        condition: service_completed_successfully
    restart: "no"
    profiles:
      - dev
      - functional

  # Mailpit for email testing
  mailpit:
    image: axllent/mailpit:latest
    labels:
      - "traefik.http.routers.mailpit.rule=Host(`mailpit.${COMPOSE_DOMAIN:-mcm.localhost}`)"
      - "traefik.http.services.mailpit.loadbalancer.server.port=8025"
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8025/api/v1/info"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  prepare-keycloak-realm:
    image: steinbrueckri/envsubst
    working_dir: /work
    configs:
      - source: realm-template
        target: /template/dfsps-realm.json.template
        mode: 0444
    volumes:
      - keycloak-import:/work            # writeable volume shared with Keycloak
    env_file:
      - ./docker/keycloak/dfsp-realm.env
    entrypoint: |
      sh -c '
        echo "Rendering realm import ..."
        envsubst < /template/dfsps-realm.json.template > /work/dfsps-realm.json
      '
    restart: "no"

  keycloak:
    image: keycloak/keycloak:26.3
    command: start-dev --import-realm
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin
      - KC_HEALTH_ENABLED=true
      - KC_HOSTNAME=keycloak.${COMPOSE_DOMAIN:-mcm.localhost}
      - KC_HOSTNAME_STRICT=true
    labels:
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.${COMPOSE_DOMAIN:-mcm.localhost}`)"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
    volumes:
      - keycloak-import:/opt/keycloak/data/import
    depends_on:
      mailpit:
        condition: service_healthy
      prepare-keycloak-realm:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/9000;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;timeout 1 cat <&3 | grep -q UP"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
